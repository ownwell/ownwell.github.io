<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Gradle插件开发(3) - 无侵入的函数运行时间统计的实现 | Cyning</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Gradle插件开发(3) - 无侵入的函数运行时间统计的实现</h1><a id="logo" href="/.">Cyning</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Gradle插件开发(3) - 无侵入的函数运行时间统计的实现</h1><div class="post-meta">Sep 4, 2018<span> | </span><span class="category"><a href="/categories/Android/">Android</a></span></div><div class="post-content"><p><a href="http://ownwell.github.io/2018/08/20/android-gradle-2/">Gradle插件开发(2) - extensions和Task</a></p>
<p>经过前边两篇介绍，我们了解了Gradle的基础知识和如何写一个自己的插件，我们今天,开始实战，搞点有趣的东西。</p>
<h1><span id="准备">准备</span></h1><p>今天前面的介绍，我们是可以实现自己的自定义task，当时android在构建是一个很琐碎的过程，之前的各个环节都是task，为了让开发人员更少也更好写业务代码，后来出了一套<code>Transform API</code>。</p>
<p><img src="https://raw.githubusercontent.com/ownwell/image-bed/master/2019-06-11-23-03-00.jpg" alt></p>
<h2><span id="transform">Transform</span></h2><h3><span id="transform-介绍">Transform 介绍</span></h3><p><code>Transform</code>是特意为Android打造的，按照官网的解释如下:</p>
<p>Starting with 1.5.0-beta1, the Gradle plugin includes a Transform API allowing 3rd party plugins to manipulate compiled class files before they are converted to dex files.<br>(The API existed in 1.4.0-beta2 but it’s been completely revamped in 1.5.0-beta1)</p>
<p>The goal of this API is to simplify injecting custom class manipulations without having to deal with tasks, and to offer more flexibility on what is manipulated. The internal code processing (jacoco, progard, multi-dex) have all moved to this new mechanism already in 1.5.0-beta1.<br>Note: this applies only to the javac/dx code path. Jack does not use this API at the moment.</p>
<p>简单解释下就是：</p>
<ol>
<li><code>Transforms</code>是重新引入的，主要作用在对class的处理上，也是在生成dex文件前。</li>
<li><code>Transforms</code>有很强大功能，避免了大家使用task，内部可以处理<code>jacoco, progard, multi-dex</code>等过程。</li>
</ol>
<p>在Android studio下我们若是执行<code>./gradlew tasks</code>就会发现很多以<code>那么Transforms</code>开头的task。</p>
<h3><span id="transform-api">Transform API</span></h3><p>我们可以注册多个transform,这个类似于<code>task</code>流式关系。<br>这写API可以参考<a href="https://juejin.im/entry/59776f2bf265da6c4741db2b" target="_blank" rel="noopener">如何理解 Transform API</a>，可以认为<code>transform</code>是码头搬运的师父，你加入一个人，不影响个整体的码头的云端，前提是你要按照码头的规矩办事。<br>那么<code>transform</code>遵循码头的那些规矩呢？当然就是<code>Transforms</code>的API了,你要严格按照这个API定义每一步。<br>那么Transforms 有哪些API呢：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XXXTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;QualifiedContent.ContentType&gt; getInputTypes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;? <span class="keyword">super</span> QualifiedContent.Scope&gt; getScopes() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIncremental</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(TransformInvocation transformInvocation)</span> <span class="keyword">throws</span> TransformException, InterruptedException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.transform(transformInvocation);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>来解释下每个函数的作用：</p>
<ol>
<li><p><code>getName</code>定义<code>transform</code>的名字，便于程序区分</p>
</li>
<li><p><code>getInputTypes</code>拦截输入的流的类型，哪些它会拦截呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformManager</span> <span class="keyword">extends</span> <span class="title">FilterableStreamCollection</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;ContentType&gt; CONTENT_CLASS;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;ContentType&gt; CONTENT_JARS;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;ContentType&gt; CONTENT_RESOURCES;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;ContentType&gt; CONTENT_NATIVE_LIBS;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;ContentType&gt; CONTENT_DEX;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;ContentType&gt; CONTENT_JACK;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>getScopes是指transform的作用域，可以管理子模块还是其他的，具体参考<code>TransformManager</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Scope&gt; SCOPE_FULL_PROJECT = Sets.immutableEnumSet(</span><br><span class="line">        Scope.PROJECT,</span><br><span class="line">        Scope.PROJECT_LOCAL_DEPS,</span><br><span class="line">        Scope.SUB_PROJECTS,</span><br><span class="line">        Scope.SUB_PROJECTS_LOCAL_DEPS,</span><br><span class="line">        Scope.EXTERNAL_LIBRARIES);</span><br><span class="line">             </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;QualifiedContent.ScopeType&gt; SCOPE_FULL_INSTANT_RUN_PROJECT =</span><br><span class="line">        <span class="keyword">new</span> ImmutableSet.Builder&lt;QualifiedContent.ScopeType&gt;()</span><br><span class="line">                .addAll(SCOPE_FULL_PROJECT)</span><br><span class="line">                .add(InternalScope.MAIN_SPLIT)</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Scope&gt; SCOPE_FULL_LIBRARY = Sets.immutableEnumSet(</span><br><span class="line">        Scope.PROJECT,</span><br><span class="line">        Scope.PROJECT_LOCAL_DEPS);</span><br></pre></td></tr></table></figure>
</li>
<li><p>isIncremental：用于指明是否是增量构建</p>
</li>
<li><p><code>transform(TransformInvocation transformInvocation)</code>是整个类的核心，inputs中是传过来的输入流，其中有两种格式，一种是jar包格式一种是目录格式。outputProvider 获取到输出目录，最后将修改的文件复制到输出目录，这一步必须做不然编译会报错。</p>
</li>
</ol>
<h3><span id="注册transform">注册<code>Transform</code></span></h3><p>注册一个<code>Transform</code>到项目里，需要通过<code>Plugin</code>实现，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TranPlugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">apply</span><span class="params">(Project project)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"------------------开始----------------------"</span>);</span><br><span class="line">        <span class="comment">//AppExtension就是build.gradle中android&#123;...&#125;这一块</span></span><br><span class="line">        def android = project.extensions.getByType(AppExtension)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册自己的Transform</span></span><br><span class="line">        def classTransform = <span class="keyword">new</span> ClassTransform(project);</span><br><span class="line">        android.registerTransform(classTransform);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"------------------结束了吗----------------------"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3><span id="实现自己的transform">实现自己的<code>Transform</code></span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassTransform</span> <span class="keyword">extends</span> <span class="title">Transform</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Project mProject;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ClassTransform</span><span class="params">(Project p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mProject = p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** transform的名称</span></span><br><span class="line"><span class="comment">     * transformClassesWithMyClassTransformForDebug 运行时的名字</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"MyClassTransform"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//需要处理的数据类型，有两种枚举类型</span></span><br><span class="line">    <span class="comment">//CLASSES和RESOURCES，CLASSES代表处理的java的class文件，RESOURCES代表要处理java的资源</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;QualifiedContent.ContentType&gt; getInputTypes() &#123;</span><br><span class="line">        <span class="keyword">return</span> TransformManager.CONTENT_CLASS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指Transform要操作内容的范围，官方文档Scope有7种类型：</span></span><br><span class="line"><span class="comment">     *  EXTERNAL_LIBRARIES        只有外部库</span></span><br><span class="line"><span class="comment">     *  PROJECT                       只有项目内容</span></span><br><span class="line"><span class="comment">     *  PROJECT_LOCAL_DEPS            只有项目的本地依赖(本地jar)</span></span><br><span class="line"><span class="comment">     *  PROVIDED_ONLY                 只提供本地或远程依赖项</span></span><br><span class="line"><span class="comment">     *  SUB_PROJECTS              只有子项目。</span></span><br><span class="line"><span class="comment">     *  SUB_PROJECTS_LOCAL_DEPS   只有子项目的本地依赖项(本地jar)。</span></span><br><span class="line"><span class="comment">     *  TESTED_CODE                   由当前变量(包括依赖项)测试的代码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Set&lt;QualifiedContent.Scope&gt; getScopes() &#123;</span><br><span class="line">        <span class="keyword">return</span> TransformManager.SCOPE_FULL_PROJECT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指明当前Transform是否支持增量编译</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIncremental</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transform中的核心方法</span></span><br><span class="line"><span class="comment">     * inputs中是传过来的输入流，其中有两种格式，一种是jar包格式一种是目录格式。</span></span><br><span class="line"><span class="comment">     * outputProvider 获取到输出目录，最后将修改的文件复制到输出目录，这一步必须做不然编译会报错</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(Context context,</span></span></span><br><span class="line"><span class="function"><span class="params">                          Collection&lt;TransformInput&gt; inputs,</span></span></span><br><span class="line"><span class="function"><span class="params">                          Collection&lt;TransformInput&gt; referencedInputs,</span></span></span><br><span class="line"><span class="function"><span class="params">                          TransformOutputProvider outputProvider,</span></span></span><br><span class="line"><span class="function"><span class="params">                          <span class="keyword">boolean</span> isIncremental)</span> <span class="keyword">throws</span> IOException, TransformException, InterruptedException </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"----------------进入transform了--------------"</span>)</span><br><span class="line"></span><br><span class="line">       </span><br><span class="line">        System.out.println(<span class="string">"--------------结束transform了----------------"</span>)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若这样，什么都不写，是我们的<code>transform</code>会报错，我们可以将遍历<code>input</code>文件，:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//遍历input</span></span><br><span class="line">        inputs.each &#123;</span><br><span class="line">            TransformInput input -&gt;</span><br><span class="line">                <span class="comment">//遍历文件夹</span></span><br><span class="line">                input.directoryInputs.each &#123;</span><br><span class="line">                    DirectoryInput directoryInput -&gt;</span><br><span class="line">                       </span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 获取output目录</span></span><br><span class="line">                        def dest = outputProvider.getContentLocation(directoryInput.name,</span><br><span class="line">                                directoryInput.contentTypes, directoryInput.scopes, Format.DIRECTORY)</span><br><span class="line">                        println(directoryInput.file.getPath() + <span class="string">" ---&gt; "</span> + dest.toPath())</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 将input的目录复制到output指定目录</span></span><br><span class="line">                        FileUtils.copyDirectory(directoryInput.file, dest)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">////遍历jar文件 对jar不操作，但是要输出到out路径</span></span><br><span class="line">                input.jarInputs.each &#123;</span><br><span class="line">                    JarInput jarInput -&gt;</span><br><span class="line">                        <span class="comment">// 重命名输出文件（同目录copyFile会冲突）</span></span><br><span class="line">                        def jarName = jarInput.name</span><br><span class="line">                        println(<span class="string">"jar = "</span> + jarInput.file.getAbsolutePath())</span><br><span class="line">                        def md5Name = DigestUtils.md5Hex(jarInput.file.getAbsolutePath())</span><br><span class="line">                        <span class="keyword">if</span> (jarName.endsWith(<span class="string">".jar"</span>)) &#123;</span><br><span class="line">                            jarName = jarName.substring(<span class="number">0</span>, jarName.length() - <span class="number">4</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                        def dest = outputProvider.getContentLocation(jarName + md5Name, jarInput.contentTypes, jarInput.scopes, Format.JAR)</span><br><span class="line">                        FileUtils.copyFile(jarInput.file, dest)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>可以看到我们什么都没做，就是copy，不过copy文件是需要重新命名一个文件。<br>这样就可以将码头搬运过程中，从上一个工人人的东西，直接传给了下一个工人，只是有少些的改动。<br>那我们若是想在其中进行少些的改动呢？这就需要用到一个神奇的工具<code>javassist</code>。</p>
<h2><span id="javassist">Javassist</span></h2><p>Javaassist可以用 Javassist 改变 Java 类的字节码，而无需真正了解关于字节码或者 Java 虚拟机(Java virtual machine JVM)结构的任何内容，这样他就可以直接修改class文件的字节码。</p>
<h3><span id="javassist-基础">Javassist 基础</span></h3><p><code>Javassist</code> 使您可以检查、编辑以及创建 Java 二进制类。检查方面基本上与通过 Reflection API 直接在 Java 中进行的一样，但是当想要修改类而不只是执行它们时，则另一种访问这些信息的方法就很有用了。这是因为 JVM 设计上并没有提供在类装载到 JVM 中后访问原始类数据的任何方法，这项工作需要在 JVM 之外完成。</p>
<p>Javassist 使用 javassist.ClassPool 类跟踪和控制所操作的类。这个类的工作方式与 JVM 类装载器非常相似，但是有一个重要的区别是它不是将装载的、要执行的类作为应用程序的一部分链接，类池使所装载的类可以通过 Javassist API 作为数据使用。</p>
<p>装载到类池中的类由 javassist.CtClass 实例表示。与标准的 Java java.lang.Class 类一样， CtClass 提供了检查类数据（如字段和方法）的方法。不过，这只是 CtClass 的部分内容，它还定义了在类中添加新字段、方法和构造函数、以及改变类、父类和接口的方法。奇怪的是，Javassist 没有提供删除一个类中字段、方法或者构造函数的任何方法。</p>
<p>字段、方法和构造函数分别由 javassist.CtField、javassist.CtMethod 和 javassist.CtConstructor 的实例表示。这些类定义了修改由它们所表示的对象的所有方法的方法，包括方法或者构造函数中的实际字节码内容。</p>
<h3><span id="读写">读写</span></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ClassPool pool = ClassPool.getDefault();</span><br><span class="line">CtClass cc = pool.get(<span class="string">"me.cyning.cc.Rectangle"</span>);</span><br><span class="line">cc.setSuperclass(pool.get(<span class="string">"me.cyning.cc.Point"</span>));</span><br><span class="line">cc.writeFile();</span><br></pre></td></tr></table></figure>

<p>这样就将<code>test.Rectangle</code>的父类设置为<code>test.Point</code>,其中 <code>pool.get(&quot;test.Rectangle&quot;)</code>就是用默认的ClassPool来装寨对应的class，并且可以使用装载的<code>CtClass</code>.</p>
<p>调用 writeFile() 后，这项修改会被写入原始类文件.<br>怎么验证呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class rc = cc.toClass();</span><br><span class="line">System.out.println(rc.getSuperclass());</span><br></pre></td></tr></table></figure>

<h3><span id="函数">函数</span></h3><p>我们可以寨函数的前面和后面插入我们的值，如何做呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ClassPool cp = ClassPool.getDefault();</span><br><span class="line"></span><br><span class="line">        CtClass cc = cp.get(<span class="string">"me.cyning.Hello"</span>);</span><br><span class="line"></span><br><span class="line">        CtMethod m = cc.getDeclaredMethod(<span class="string">"say"</span>);</span><br><span class="line">        m.insertBefore(<span class="string">"&#123; System.out.println(\"before Hello.say():\"); &#125;"</span>);</span><br><span class="line">        m.insertAfter(<span class="string">"&#123; System.out.println(\"after Hello.say():\"); &#125;"</span>);</span><br><span class="line"></span><br><span class="line">        Class c = cc.toClass();</span><br><span class="line">        Hello h = (Hello)c.newInstance();</span><br><span class="line">        h.say();</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"Hello"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先将<code>me.cyning.Hello</code>load到Javassist的ClassPool中，获取到<code>me.cyning.Hello</code>类中的<code>say</code>方法，可以在方法开始和结尾来加入函数。<br>是不是有点意思。</p>
<h1><span id="打点统计">打点统计</span></h1><p>于是我们可以在我们类中直接使用Javassist来修改我们的class字节码。<br>接着<code>transform</code>中的<code>transform</code>方法来处理，所有的class到<code>transform</code>方法中都是以class文件存在的，所以拦截文件夹。<br><img src="https://raw.githubusercontent.com/ownwell/image-bed/master/2019-06-11-21-59-43.jpg" alt></p>
<p>只需要在适当的方法里注入如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">  ``````````````````````println(<span class="string">"方法名 = "</span> + mMethod.getName())</span><br><span class="line">                        println(<span class="string">"返回类型 = "</span> + mMethod.getReturnType().getName())</span><br><span class="line"><span class="comment">//                        println("参数类型 = " + mMethod.getParameterTypes())</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 开始时间</span></span><br><span class="line">                        mMethod.addLocalVariable(<span class="string">"startMs"</span>, CtClass.longType);</span><br><span class="line"></span><br><span class="line">                        mMethod.insertBefore(<span class="string">"startMs = System.currentTimeMillis();"</span>);</span><br><span class="line">                        String body = <span class="string">"&#123;"</span> +</span><br><span class="line">                                <span class="string">"final long endMs = System.currentTimeMillis();"</span> +</span><br><span class="line"></span><br><span class="line">                                <span class="string">"System.out.println(\"Executed in ms: ["</span> + className + <span class="string">","</span> + mMethod.getName() +</span><br><span class="line">                                <span class="string">"] ---&gt; \" + (endMs-startMs));&#125;"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        println(body)</span><br><span class="line">                        mMethod.insertAfter(body)</span><br></pre></td></tr></table></figure>

<p>找到对应的class的看下，生效：<br><img src="https://raw.githubusercontent.com/ownwell/image-bed/master/img/2019-06-11-22-05-41.jpg" alt></p>
<p>最后的代码：<br><a href="https://github.com/ownwell/Gradle-plugin" target="_blank" rel="noopener">https://github.com/ownwell/Gradle-plugin</a></p>
<h1><span id="参考文章">参考文章</span></h1><p><a href="http://tools.android.com/tech-docs/new-build-system/transform-api" target="_blank" rel="noopener">Transform API</a><br><a href="https://www.jianshu.com/p/c9ce643e2f22" target="_blank" rel="noopener">Android Plugin Transform 初探</a><br><a href="http://blog.lanxijun.com/?p=98" target="_blank" rel="noopener">Gradle通过Transform API实现代码注入</a><br><a href="http://wiki.jikexueyuan.com/project/deep-android-gradle/" target="_blank" rel="noopener">深入理解 Android 之 Gradle</a><br><a href="https://github.com/jboss-javassist/javassist/wiki/Tutorial-1" target="_blank" rel="noopener">Tutorial 1</a><br><a href="https://www.diycode.cc/topics/786" target="_blank" rel="noopener">Android ASM 插桩初步实现</a><br><a href="https://yq.aliyun.com/articles/70337" target="_blank" rel="noopener">Android热修复技术——QQ空间补丁方案解析(3)</a><br><br><a href="http://tech.lede.com/2017/02/11/rd/android/android_aop/" target="_blank" rel="noopener">网易乐得-Android AOP之字节码插桩</a></p>
</div><div class="tags"><a href="/tags/Gradle/">Gradle</a></div><div class="post-nav"><a class="pre" href="/2018/12/23/Aspect和aop打点调研/">Aspect和AOP打点调研</a><a class="next" href="/2018/08/20/android-gradle-2/">Gradle插件开发(2) - extensions和Task</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="http://ownwell.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Flutter/">Flutter</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kotlin/">Kotlin</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tools/">Tools</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/周报/">周报</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据分析/">数据分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生活/">生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/编程/">编程</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书/">读书</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/JCenter/" style="font-size: 15px;">JCenter</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Mac/" style="font-size: 15px;">Mac</a> <a href="/tags/CodeStyle/" style="font-size: 15px;">CodeStyle</a> <a href="/tags/IDEA/" style="font-size: 15px;">IDEA</a> <a href="/tags/Ruby/" style="font-size: 15px;">Ruby</a> <a href="/tags/Android源码/" style="font-size: 15px;">Android源码</a> <a href="/tags/Material/" style="font-size: 15px;">Material</a> <a href="/tags/Google/" style="font-size: 15px;">Google</a> <a href="/tags/Git/" style="font-size: 15px;">Git</a> <a href="/tags/Sublime-Text/" style="font-size: 15px;">Sublime Text</a> <a href="/tags/抓包/" style="font-size: 15px;">抓包</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Transition/" style="font-size: 15px;">Transition</a> <a href="/tags/Animations/" style="font-size: 15px;">Animations</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/生活/" style="font-size: 15px;">生活</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/Jenkins/" style="font-size: 15px;">Jenkins</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/JavaEE/" style="font-size: 15px;">JavaEE</a> <a href="/tags/UI/" style="font-size: 15px;">UI</a> <a href="/tags/View/" style="font-size: 15px;">View</a> <a href="/tags/Realm/" style="font-size: 15px;">Realm</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/注解/" style="font-size: 15px;">注解</a> <a href="/tags/热修复/" style="font-size: 15px;">热修复</a> <a href="/tags/2018/" style="font-size: 15px;">2018</a> <a href="/tags/Kotlin/" style="font-size: 15px;">Kotlin</a> <a href="/tags/服务器/" style="font-size: 15px;">服务器</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/译文/" style="font-size: 15px;">译文</a> <a href="/tags/动态代理/" style="font-size: 15px;">动态代理</a> <a href="/tags/编程/" style="font-size: 15px;">编程</a> <a href="/tags/JNI开发/" style="font-size: 15px;">JNI开发</a> <a href="/tags/AI/" style="font-size: 15px;">AI</a> <a href="/tags/VS-code/" style="font-size: 15px;">VS code</a> <a href="/tags/Gradle/" style="font-size: 15px;">Gradle</a> <a href="/tags/pandas/" style="font-size: 15px;">pandas</a> <a href="/tags/【周报】/" style="font-size: 15px;">【周报】</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/单例/" style="font-size: 15px;">单例</a> <a href="/tags/Flutter/" style="font-size: 15px;">Flutter</a> <a href="/tags/多渠道/" style="font-size: 15px;">多渠道</a> <a href="/tags/python/" style="font-size: 15px;">python</a> <a href="/tags/Android热修复/" style="font-size: 15px;">Android热修复</a> <a href="/tags/hot-fix/" style="font-size: 15px;">hot-fix</a> <a href="/tags/Android进阶/" style="font-size: 15px;">Android进阶</a> <a href="/tags/插件化/" style="font-size: 15px;">插件化</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/26/2019年第30周-Android知识点汇总/">2019年第30周 Android知识点汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/26/flutter-learning-2/">Flutter 请求网络数据和列表展示</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/27/插件化之HookActivity/">插件化之Hook Activity</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/20/2019-06-20-alfred插件开发/">alfred插件开发-将github作为图床</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/12/Flutter-从一个demo开始/">Flutter 从一个demo开始</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/23/Aspect和aop打点调研/">Aspect和AOP打点调研</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/04/android-gradle-3/">Gradle插件开发(3) - 无侵入的函数运行时间统计的实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/20/android-gradle-2/">Gradle插件开发(2) - extensions和Task</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/17/conda-for-python2or3/">conda切换Python2和Python3环境</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/16/try-baidu-ai/">试了一把Baidu的语言处理sdk</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://wanandroid.com/" title="wanAndroid" target="_blank">wanAndroid</a><ul></ul><a href="https://blog.csdn.net/luoshengyang" title="老罗" target="_blank">老罗</a><ul></ul><a href="http://androidxref.com/" title="androidxref" target="_blank">androidxref</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">Cyning.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>