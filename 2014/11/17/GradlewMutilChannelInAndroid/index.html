<!DOCTYPE html>
<html lang="zh-cmn-Hans" prefix="og: http://ogp.me/ns#" class="han-init">
<head>
  <meta charset="utf-8">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />

  <link rel="icon" href="/favicon.ico">
  
  <title>cyning | [Android]关于Android在Gradlew多渠道打包方式</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/lib/fancybox/jquery.fancybox-1.3.4.css">
  <!--在这里倒入jquery 方便处理部分页面的jquery-->
  <script src="https://cdn.staticfile.org/jquery/1.7/jquery.min.js" type="text/javascript" ></script>
</head>

<body>
	<header class="site-header navfixed-false">
  <div class="container">
      <h1><a href="/" title="cyning"><span class="octicon octicon-mark-github"></span> cyning</a></h1>
      <nav class="site-header-nav" role="navigation">
        
              
              <a href="/"  class=" site-header-nav-item hvr-underline-from-center" title="Home">Home</a>
        
              
              <a href="/categories/"  class=" site-header-nav-item hvr-underline-from-center" title="Category">Category</a>
        
              
              <a href="/open-source/"  class=" site-header-nav-item hvr-underline-from-center" title="Open-Source">Open-Source</a>
        
              
              <a href="/message/"  class=" site-header-nav-item hvr-underline-from-center" title="Message">Message</a>
        
      </nav>
  </div>
</header>

	
<section class="collection-head geopattern" data-pattern-id="[Android]关于Android在Gradlew多渠道打包方式" >
    <div class="container">
        <div class="collection-title">
            <h1 class="collection-header">
                [Android]关于Android在Gradlew多渠道打包方式
            </h1>
            
                <div class="collection-info">
                    <span class="meta-info">
                        <span class="octicon octicon-calendar"></span>
                        <time datetime="2014-11-16T16:00:00.000Z" itemprop="datePublished">2014-11-17</time>
                    </span>
                    
                        <span class="meta-info">
                            <span class="octicon octicon-file-directory"></span>
                            <a href='/categories/Tools/' title=''>Tools</a>
                        </span>
                    
                </div>
            
        </div>
    </div>
</section>
	<section class="container">
    <div class="columns">
        <div class="column  three-fourths " >
            <article class="article-content markdown-body">
                <hr>
<p>记得以前在Eclipse开发，用的是一个插件，现在好不容易转到IDEA上（下一步就是Android Studio），在文件结构保持和Eclipse一段后，采用了Gradlew进行编译，加上我们公司的香香同学又整理好了Jenkin这个CI自动集成系统，瞬间感觉高大上了。</p>
<p>今天结束了公司的一个版本的开发，回家在整理多渠道包的问题，看了友盟的多渠道方式，有个1.11的在我机器上死活报那个manifest下没有对应渠道的manifest文件，果断采取了copy的方法，也是没办法了。<br><a id="more"></a></p>
<p>今天先把代码贴出来，明天在好好整理下，太困了。</p>
<p>```Java<br>    apply plugin: ‘android’</p>
<pre><code>android {
    compileSdkVersion    19
    buildToolsVersion    &quot;19.1&quot;

    sourceSets {
        main {
            manifest.srcFile &apos;AndroidManifest.xml&apos;
            java.srcDirs = [&apos;src&apos;]
            res.srcDirs = [&apos;res&apos;]
            assets.srcDirs = [&apos;assets&apos;]
        }

    }    

    defaultConfig {
        minSdkVersion    11
        targetSdkVersion    19
        versionCode    20141107
        versionName    &quot;2.2.0&quot;
    }

    packagingOptions {
        exclude &apos;META-INF/DEPENDENCIES.txt&apos;
        exclude &apos;META-INF/LICENSE.txt&apos;
        exclude &apos;META-INF/NOTICE.txt&apos;
        exclude &apos;META-INF/NOTICE&apos;
        exclude &apos;META-INF/LICENSE&apos;
        exclude &apos;META-INF/DEPENDENCIES&apos;
        exclude &apos;META-INF/notice.txt&apos;
        exclude &apos;META-INF/license.txt&apos;
        exclude &apos;META-INF/dependencies.txt&apos;
        exclude &apos;META-INF/LGPL2.1&apos;
    }



//下面一段是将libs/*/*.so文件加入打包
//如果你的项目是使用Eclipse+ADT建立的，则需要这段代码
    task copyNativeLibs(type: Copy) {
        from(new File(&apos;libs&apos;)) { include &apos;**/*.so&apos; }
        into new File(buildDir, &apos;native-libs&apos;)
    }

    tasks.withType(Compile) { compileTask -&gt; compileTask.dependsOn copyNativeLibs }

    clean.dependsOn &apos;cleanCopyNativeLibs&apos;

    tasks.withType(com.android.build.gradle.tasks.PackageApplication) { pkgTask -&gt;
        pkgTask.jniFolders = new HashSet&lt;File&gt;()
        pkgTask.jniFolders.add(new File(buildDir, &apos;native-libs&apos;))
    }
    signingConfigs {
        release {
            storeFile = file(System.getenv()[&apos;APK_SIGNING_KEYSTORE&apos;])    
            storePassword = System.getenv()[&apos;APK_SIGNING_STOREPASS&apos;]
            keyAlias = System.getenv()[&apos;APK_SIGNING_KEYALIAS&apos;]
            keyPassword = System.getenv()[&apos;APK_SIGNING_KEYPASS&apos;]
        }    
    }

    buildTypes {
        release {
            signingConfig signingConfigs.release
            runProguard false    
            proguardFiles    getDefaultProguardFile(&apos;proguard-android.txt&apos;), \
                &apos;proguard-rules.txt&apos;


        }
    }

    //渠道
    productFlavors {
        Wandoujia{}
        Qihu360{}
        QQYingyongBao{}

    }

    //这个是解决lint报错的代码
    lintOptions {
        abortOnError false
    }



}


dependencies {
    compile fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])

    compile project(&quot;:libs:libapp&quot;)


}


//替换AndroidManifest.xml的UMENG_CHANNEL_VALUE字符串为渠道名称
android.applicationVariants.all{ variant -&gt;
    variant.processManifest.doLast{
        copy{
            from(&quot;${buildDir}/manifests&quot;){
                include &quot;${variant.dirName}/AndroidManifest.xml&quot;
            }
            into(&quot;${buildDir}/manifests/$variant.name&quot;)

            filter{
                String line -&gt; line.replaceAll(&quot;UMENG_CHANNEL_VALUE&quot;, &quot;$variant.name&quot;)
            }

            variant.processResources.manifestFile = file(&quot;${buildDir}/manifests/${variant.name}/${variant.dirName}/AndroidManifest.xml&quot;)


//            applicationVariants.all { variant -&gt;
                def file = variant.outputFile
                def manifestParser = new com.android.builder.core.DefaultManifestParser()
                def destName = &quot;AppName_&quot;+manifestParser.getVersionName(android.sourceSets.main.manifest.srcFile)+&quot;20141117&quot;+&quot;_&quot;+&quot;$variant.name&quot;+&quot;_release&quot;+&quot;.apk&quot;
                variant.outputFile = new File(file.parent,destName)
//            }



        }


    }


}


////替换AndroidManifest.xml的UMENG_CHANNEL_VALUE字符串为渠道名称 By Remex Huang
//android.applicationVariants.all{ variant -&gt;
//    variant.processManifest.doLast{
//
//        //之前这里用的copy{}，我换成了文件操作，这样可以在v1.11版本正常运行，并保持文件夹整洁
////${buildDir}是指./build文件夹
////${variant.dirName}是flavor/buildtype，例如GooglePlay/release，运行时会自动生成
////下面的路径是类似这样：./build/manifests/GooglePlay/release/AndroidManifest.xml
//def manifestFile = &quot;${buildDir}/manifests/${variant.dirName}/AndroidManifest.xml&quot;
//
////将字符串UMENG_CHANNEL_VALUE替换成flavor的名字
//def updatedContent = new File(manifestFile).getText(&apos;UTF-8&apos;).replaceAll(&quot;UMENG_CHANNEL_VALUE&quot;, &quot;${variant.productFlavors[0].name}&quot;)
//new File(manifestFile).write(updatedContent, &apos;UTF-8&apos;)
//
////将此次flavor的AndroidManifest.xml文件指定为我们修改过的这个文件
//variant.processResources.manifestFile = file(&quot;${buildDir}/manifests/${variant.dirName}/AndroidManifest.xml&quot;)
//}
//}
</code></pre><p>```Java</p>

            </article>
            
                <div class="share">
                    <!--开启分享-->
<div class="share-component" data-disabled="google,twitter,facebook" data-description="
记得以前在Eclipse开发，用的是一个插件，现在好..."></div>

<script src="/js/share.min.js"></script>

                </div>    
            

            
            
                
<div class="comments">
    <div id="container"></div>
        <script src="/js/gitment.browser.js"></script>
         <script>
            var gitment = new Gitment({
                id: '/2014/11/17/GradlewMutilChannelInAndroid/',
                owner: 'undefined',
                repo: 'undefined',
                oauth: {
                    client_id: "undefined",
                    client_secret: "undefined",
                }
            })
        gitment.render('container')
        </script>
</div>

            

        </div>
        <div class="column one-fourth">
            
                
                


<h3>Post Directory</h3>

<div id="post-directory-module">
	<section class="post-directory">
		<p><strong class="toc-title">文章目录</strong></p>
		
	</section>
</div>
            
        </div>
    </div>
</section>

<footer class="container">
    <div class="site-footer" role="contentinfo">
        <div class="copyright left mobile-block">
                © 2016
                <span title="yumemor">yumemor</span>
                <a href="javascript:window.scrollTo(0,0)" class="right mobile-visible">TOP</a>
        </div>

        <ul class="site-footer-links right mobile-hidden">
            <li>
                <a href="javascript:window.scrollTo(0,0)" >TOP</a>
            </li>
        </ul>

        <a href="https://github.com/yumemor/hexo-theme-primer" target="_blank" aria-label="view source code">
            <span class="mega-octicon octicon-mark-github" title="GitHub"></span>
        </a>

        <ul class="site-footer-links mobile-hidden">
            
                  
                  <li>
                    <a href="/"  title="Home">Home</a>
                  </li>
            
                  
                  <li>
                    <a href="/categories/"  title="Category">Category</a>
                  </li>
            
                  
                  <li>
                    <a href="/open-source/"  title="Open-Source">Open-Source</a>
                  </li>
            
                  
                  <li>
                    <a href="/message/"  title="Message">Message</a>
                  </li>
            
            <li>
                <a href="/atom.xml">
                    <span class="octicon octicon-rss" style="color:orange;"></span>
                </a>
            </li>
        </ul>
    </div>
</footer>

		<script src="/js/geopattern.js"></script>
		<script src="/js/highlight.pack.js"></script>
		<script src="/lib/fancybox/jquery.fancybox-1.3.4.pack.js"></script>

		
			<script src="/js/toc.js"></script>
		

		<script src="/js/index.js"></script>

		 <script src="/js/popular_repo.js"></script> 

	</body>
</html>